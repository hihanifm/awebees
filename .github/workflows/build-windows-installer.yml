name: Build Windows Installers

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 3.4.0)'
        required: true
        type: string

jobs:
  build:
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Determine version
        id: get_version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"
      
      - name: Extract packages
        shell: bash
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          mkdir -p build/windows
          
          # Extract with-python package
          unzip "dist/windows/lens-package-with-python-${VERSION}.zip" -d build/windows/
          mv "build/windows/lens-app-with-python" "build/windows/lens-app-with-python"
          
          # Extract requires-python package
          unzip "dist/windows/lens-package-requires-python-${VERSION}.zip" -d build/windows/
          mv "build/windows/lens-app-requires-python" "build/windows/lens-app-requires-python"
          
          echo "Package extraction complete"
          ls -la build/windows/
      
      - name: Install NSIS
        shell: pwsh
        run: |
          choco install nsis -y
          $env:PATH = "C:\Program Files (x86)\NSIS;$env:PATH"
          [Environment]::SetEnvironmentVariable("PATH", $env:PATH, [EnvironmentVariableTarget]::Process)
          makensis /VERSION
      
      - name: Build installers
        shell: pwsh
        run: |
          $VERSION = "${{ steps.get_version.outputs.VERSION }}"
          $env:PATH = "C:\Program Files (x86)\NSIS;$env:PATH"
          
          # Create output directory
          New-Item -ItemType Directory -Force -Path "dist/installers"
          
          # Build with-python installer
          Write-Host "Building self-contained installer..."
          makensis /DVERSION=$VERSION `
                   /DBUILD_DIR="build\windows" `
                   /DOUTDIR="dist\installers" `
                   scripts\windows\installer-with-python.nsi
          
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Failed to build with-python installer"
            exit 1
          }
          
          # Build requires-python installer
          Write-Host "Building requires-python installer..."
          makensis /DVERSION=$VERSION `
                   /DBUILD_DIR="build\windows" `
                   /DOUTDIR="dist\installers" `
                   scripts\windows\installer-requires-python.nsi
          
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Failed to build requires-python installer"
            exit 1
          }
          
          Write-Host "Installer build complete"
          Get-ChildItem dist\installers
      
      - name: Rename installers with version
        shell: bash
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          cd dist/installers
          
          mv lens-setup-with-python.exe "lens-setup-with-python-${VERSION}.exe"
          mv lens-setup-requires-python.exe "lens-setup-requires-python-${VERSION}.exe"
          
          echo "Installers renamed:"
          ls -lh
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            dist/installers/*.exe
          body: |
            ## Lens v${{ steps.get_version.outputs.VERSION }}
            
            ### Windows Installers
            
            **Self-Contained Installer (Recommended)**
            - Includes Python runtime
            - No additional software required
            - Download: `lens-setup-with-python-${{ steps.get_version.outputs.VERSION }}.exe`
            
            **Python-Required Installer**
            - Requires Python 3.x to be installed
            - Smaller download size
            - Download: `lens-setup-requires-python-${{ steps.get_version.outputs.VERSION }}.exe`
            
            ### Installation
            
            1. Download the appropriate installer
            2. Run the installer and follow the prompts
            3. Launch Lens from the Start Menu or Desktop shortcut
            
            See [CHANGELOG.md](https://github.com/hihanifm/awebees/blob/master/CHANGELOG.md) for full release notes.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-installers-${{ steps.get_version.outputs.VERSION }}
          path: dist/installers/*.exe
          retention-days: 90
